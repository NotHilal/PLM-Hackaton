<div class="python-overview-container">
  <!-- Header -->
  <div class="page-header mb-xl">
    <div class="header-content">
      <h2 class="page-title">Process Mining Overview</h2>
      <p class="page-subtitle">Donn√©es en temps r√©el depuis Python Backend</p>
    </div>
    <button class="btn btn-primary" (click)="refresh()" [disabled]="loading">
      {{ loading ? 'Chargement...' : 'Actualiser' }}
    </button>
  </div>

  <!-- Loading State -->
  <div *ngIf="loading" class="loading">
    <div class="spinner"></div>
    <p>Chargement des donn√©es depuis Python...</p>
  </div>

  <!-- Error State -->
  <div *ngIf="error && !loading" class="card error-card">
    <h3>‚ùå Erreur</h3>
    <p>{{ error }}</p>
    <button class="btn btn-primary mt-md" (click)="refresh()">R√©essayer</button>
  </div>

  <!-- Main Content -->
  <div *ngIf="!loading && !error && processMiningKPIs">
    <!-- KPI Header Section -->
    <div class="kpi-header grid grid-cols-4 mb-xl">
      <!-- Total WIP Card -->
      <div class="kpi-card">
        <div class="kpi-label">Total WIP</div>
        <div class="kpi-value">{{ processMiningKPIs.totalWIP }}</div>
        <div class="kpi-delta" [ngClass]="getDeltaClass(processMiningKPIs.deltaWIP)">
          {{ formatDelta(processMiningKPIs.deltaWIP) }}
        </div>
      </div>

      <!-- Average Lead Time Card -->
      <div class="kpi-card">
        <div class="kpi-label">D√©lai Moyen</div>
        <div class="kpi-value">{{ processMiningKPIs.avgLeadTime.toFixed(1) }}h</div>
        <div class="kpi-delta" [ngClass]="getDeltaClass(processMiningKPIs.deltaLeadTime)">
          {{ formatDelta(processMiningKPIs.deltaLeadTime) }}
        </div>
      </div>

      <!-- Rework Rate Card - Enhanced -->
      <div class="kpi-card rework-card">
        <div class="kpi-label">Taux de Reprise</div>
        <div class="kpi-value">{{ processMiningKPIs.reworkRate.toFixed(1) }}%</div>
        <div class="badge" [ngClass]="processMiningKPIs.reworkRate > 40 ? 'badge-error' : processMiningKPIs.reworkRate > 25 ? 'badge-warning' : 'badge-success'">
          {{ processMiningKPIs.reworkRate > 40 ? 'S√©v√®re' : processMiningKPIs.reworkRate > 25 ? 'Mod√©r√©' : 'Normal' }}
        </div>
        <div *ngIf="processMiningKPIs.varianceBreakdown" class="kpi-detail">
          <span class="text-muted" style="font-size: 0.75rem;">
            √âcart moyen: +{{ processMiningKPIs.varianceBreakdown.avgVariancePct.toFixed(1) }}%
          </span>
        </div>
      </div>

      <!-- Throughput Card -->
      <div class="kpi-card">
        <div class="kpi-label">D√©bit</div>
        <div class="kpi-value">{{ processMiningKPIs.throughput.toFixed(1) }}</div>
        <div class="text-muted" style="font-size: 0.875rem;">cas/jour</div>
      </div>
    </div>

    <!-- Bottleneck Info Bar -->
    <div class="card mb-xl" *ngIf="processMiningKPIs.bottleneckOperation">
      <div class="flex items-center justify-between">
        <div>
          <span class="text-muted">Goulot Principal Identifi√©:</span>
          <strong class="ml-sm" style="font-size: 1.1rem; color: var(--text-primary);">
            {{ processMiningKPIs.bottleneckOperation }}
          </strong>
        </div>
        <span class="badge badge-error">Critique</span>
      </div>
    </div>

    <!-- Variance Breakdown Section -->
    <div class="card mb-xl variance-breakdown-card" *ngIf="processMiningKPIs.varianceBreakdown">
      <div class="card-header">
        <span>‚ö†Ô∏è Analyse des √âcarts de Temps</span>
        <span class="text-muted" style="font-size: 0.875rem; font-weight: normal;">
          (√âcart = Temps R√©el vs Temps Pr√©vu)
        </span>
      </div>
      <div class="card-body">
        <div class="variance-stats-grid">
          <div class="variance-stat variance-ontime">
            <div class="variance-stat-label">√Ä l'heure (‚â§10%)</div>
            <div class="variance-stat-value">{{ processMiningKPIs.varianceBreakdown.onTime }}</div>
            <div class="variance-stat-pct">{{ processMiningKPIs.varianceBreakdown.onTimePct.toFixed(1) }}%</div>
          </div>
          <div class="variance-stat variance-minor">
            <div class="variance-stat-label">Retard mineur (10-25%)</div>
            <div class="variance-stat-value">{{ processMiningKPIs.varianceBreakdown.minorDelay }}</div>
            <div class="variance-stat-pct">{{ processMiningKPIs.varianceBreakdown.minorDelayPct.toFixed(1) }}%</div>
          </div>
          <div class="variance-stat variance-moderate">
            <div class="variance-stat-label">Retard mod√©r√© (25-40%)</div>
            <div class="variance-stat-value">{{ processMiningKPIs.varianceBreakdown.moderateDelay }}</div>
            <div class="variance-stat-pct">{{ processMiningKPIs.varianceBreakdown.moderateDelayPct.toFixed(1) }}%</div>
          </div>
          <div class="variance-stat variance-severe">
            <div class="variance-stat-label">Retard s√©v√®re (>40%)</div>
            <div class="variance-stat-value">{{ processMiningKPIs.varianceBreakdown.severeDelay }}</div>
            <div class="variance-stat-pct">{{ processMiningKPIs.varianceBreakdown.severeDelayPct.toFixed(1) }}%</div>
          </div>
        </div>

        <!-- Visual Progress Bar -->
        <div class="variance-progress-bar">
          <div class="variance-segment variance-ontime"
               [style.width.%]="processMiningKPIs.varianceBreakdown.onTimePct"
               *ngIf="processMiningKPIs.varianceBreakdown.onTimePct > 0">
          </div>
          <div class="variance-segment variance-minor"
               [style.width.%]="processMiningKPIs.varianceBreakdown.minorDelayPct"
               *ngIf="processMiningKPIs.varianceBreakdown.minorDelayPct > 0">
          </div>
          <div class="variance-segment variance-moderate"
               [style.width.%]="processMiningKPIs.varianceBreakdown.moderateDelayPct"
               *ngIf="processMiningKPIs.varianceBreakdown.moderateDelayPct > 0">
          </div>
          <div class="variance-segment variance-severe"
               [style.width.%]="processMiningKPIs.varianceBreakdown.severeDelayPct"
               *ngIf="processMiningKPIs.varianceBreakdown.severeDelayPct > 0">
          </div>
        </div>

        <div class="variance-info-footer">
          <span class="text-muted">
            üí° Seuil de reprise actuel: <strong>>40%</strong> d'√©cart |
            √âcart moyen: <strong>+{{ processMiningKPIs.varianceBreakdown.avgVariancePct.toFixed(1) }}%</strong>
          </span>
        </div>
      </div>
    </div>

    <!-- Charts Section -->
    <div class="grid grid-cols-1 gap-lg mb-xl">
      <!-- WIP by Operation Chart -->
      <div class="chart-container">
        <div class="chart-title">Work in Progress par Op√©ration (Top 10)</div>
        <ngx-charts-bar-vertical
          [view]="view"
          [results]="getTopWIPData()"
          [xAxis]="showXAxis"
          [yAxis]="showYAxis"
          [legend]="false"
          [showXAxisLabel]="true"
          [showYAxisLabel]="true"
          [xAxisLabel]="'Op√©ration'"
          [yAxisLabel]="'WIP Count'"
          [scheme]="colorScheme"
          [gradient]="true"
          [roundEdges]="true"
          [trimXAxisTicks]="true"
          [maxXAxisTickLength]="20"
          [rotateXAxisTicks]="false">
        </ngx-charts-bar-vertical>
      </div>

      <!-- Cycle vs Waiting Time Chart -->
      <div class="chart-container">
        <div class="chart-title">Temps de Cycle vs Temps d'Attente (Top 10)</div>
        <ngx-charts-bar-vertical-stacked
          [view]="view"
          [results]="getTopCycleWaitingData()"
          [xAxis]="showXAxis"
          [yAxis]="showYAxis"
          [legend]="true"
          [showXAxisLabel]="true"
          [showYAxisLabel]="true"
          [xAxisLabel]="'Op√©ration'"
          [yAxisLabel]="'Temps (minutes)'"
          [scheme]="colorScheme"
          [trimXAxisTicks]="true"
          [maxXAxisTickLength]="20"
          [rotateXAxisTicks]="false">
        </ngx-charts-bar-vertical-stacked>
      </div>
    </div>

    <!-- Operation Summary Table -->
    <div class="card mt-xl">
      <div class="card-header">D√©tails des Op√©rations (Donn√©es Python)</div>
      <div class="card-body">
        <table class="data-table">
          <thead>
            <tr>
              <th>Op√©ration</th>
              <th>WIP</th>
              <th>Temps Cycle Moy.</th>
              <th>Temps Attente Moy.</th>
              <th>√âcart Temps %</th>
              <th>Nombre de Cas</th>
              <th>Taux Reprise</th>
              <th>D√©bit</th>
              <th>Goulot</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let op of operations">
              <td><strong>{{ op.operation }}</strong></td>
              <td>{{ op.currentWIP }}</td>
              <td>{{ (op.avgCycleTime * 60).toFixed(0) }} min</td>
              <td>{{ (op.avgWaitingTime * 60).toFixed(0) }} min</td>
              <td>
                <span *ngIf="op.avgVariancePct"
                      class="variance-badge"
                      [ngClass]="{
                        'variance-severe': op.avgVariancePct > 40,
                        'variance-moderate': op.avgVariancePct > 25 && op.avgVariancePct <= 40,
                        'variance-minor': op.avgVariancePct > 10 && op.avgVariancePct <= 25,
                        'variance-ontime': op.avgVariancePct <= 10
                      }">
                  +{{ op.avgVariancePct.toFixed(1) }}%
                </span>
                <span *ngIf="!op.avgVariancePct" class="text-muted">-</span>
              </td>
              <td>{{ op.caseCount }}</td>
              <td>
                <span [ngClass]="{
                  'text-error': op.reworkRate > 40,
                  'text-warning': op.reworkRate > 25 && op.reworkRate <= 40,
                  'text-success': op.reworkRate <= 25
                }">
                  {{ op.reworkRate.toFixed(1) }}%
                </span>
              </td>
              <td>{{ op.throughput.toFixed(1) }}/jour</td>
              <td>
                <span
                  class="badge"
                  [ngClass]="getSeverityBadgeClass(op.bottleneckSeverity)">
                  {{ op.bottleneckSeverity }}
                </span>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Backend Info -->
    <div class="card mt-xl" style="background: rgba(59, 130, 246, 0.1); border-color: var(--primary-blue-light);">
      <div class="flex items-center gap-md">
        <span style="font-size: 2rem;">üêç</span>
        <div>
          <strong style="color: var(--primary-blue-light);">Backend Python Actif</strong>
          <p class="text-muted" style="font-size: 0.875rem; margin-top: 0.25rem;">
            Toutes les donn√©es sont calcul√©es par le backend Python et mises √† jour en temps r√©el.
          </p>
        </div>
      </div>
    </div>
  </div>
</div>
