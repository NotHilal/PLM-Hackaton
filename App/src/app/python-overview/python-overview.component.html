<div class="python-overview-container">
  <!-- Header -->
  <div class="page-header mb-xl">
    <div class="header-content">
      <h2 class="page-title">Process Mining Overview</h2>
      <p class="page-subtitle">Donn√©es en temps r√©el depuis Python Backend</p>
    </div>
    <button class="btn btn-primary" (click)="refresh()" [disabled]="loading">
      {{ loading ? 'Chargement...' : 'Actualiser' }}
    </button>
  </div>

  <!-- Loading State -->
  <div *ngIf="loading" class="loading">
    <div class="spinner"></div>
    <p>Chargement des donn√©es depuis Python...</p>
  </div>

  <!-- Error State -->
  <div *ngIf="error && !loading" class="card error-card">
    <h3>‚ùå Erreur</h3>
    <p>{{ error }}</p>
    <button class="btn btn-primary mt-md" (click)="refresh()">R√©essayer</button>
  </div>

  <!-- Main Content -->
  <div *ngIf="!loading && !error && processMiningKPIs">
    <!-- KPI Header Section -->
    <div class="kpi-header grid grid-cols-4 mb-xl">
      <!-- Total WIP Card -->
      <div class="kpi-card">
        <div class="kpi-label">Total WIP</div>
        <div class="kpi-value">{{ processMiningKPIs.totalWIP }}</div>
        <div class="kpi-delta" [ngClass]="getDeltaClass(processMiningKPIs.deltaWIP)">
          {{ formatDelta(processMiningKPIs.deltaWIP) }}
        </div>
      </div>

      <!-- Average Lead Time Card -->
      <div class="kpi-card">
        <div class="kpi-label">D√©lai Moyen</div>
        <div class="kpi-value">{{ processMiningKPIs.avgLeadTime.toFixed(1) }}h</div>
        <div class="kpi-delta" [ngClass]="getDeltaClass(processMiningKPIs.deltaLeadTime)">
          {{ formatDelta(processMiningKPIs.deltaLeadTime) }}
        </div>
      </div>

      <!-- Rework Rate Card -->
      <div class="kpi-card">
        <div class="kpi-label">Taux de Reprise</div>
        <div class="kpi-value">{{ processMiningKPIs.reworkRate.toFixed(1) }}%</div>
        <div class="badge" [ngClass]="processMiningKPIs.reworkRate > 10 ? 'badge-error' : 'badge-success'">
          {{ processMiningKPIs.reworkRate > 10 ? '√âlev√©' : 'Normal' }}
        </div>
      </div>

      <!-- Throughput Card -->
      <div class="kpi-card">
        <div class="kpi-label">D√©bit</div>
        <div class="kpi-value">{{ processMiningKPIs.throughput.toFixed(1) }}</div>
        <div class="text-muted" style="font-size: 0.875rem;">cas/jour</div>
      </div>
    </div>

    <!-- Bottleneck Info Bar -->
    <div class="card mb-xl" *ngIf="processMiningKPIs.bottleneckOperation">
      <div class="flex items-center justify-between">
        <div>
          <span class="text-muted">Goulot Principal Identifi√©:</span>
          <strong class="ml-sm" style="font-size: 1.1rem; color: var(--text-primary);">
            {{ processMiningKPIs.bottleneckOperation }}
          </strong>
        </div>
        <span class="badge badge-error">Critique</span>
      </div>
    </div>

    <!-- Charts Grid -->
    <div class="grid grid-cols-2 mb-xl">
      <!-- Cycle vs Waiting Time Chart -->
      <div class="chart-container">
        <div class="chart-title">Temps de Cycle vs Temps d'Attente</div>
        <div #chartWrapper class="chart-wrapper">
        <ngx-charts-bar-vertical-stacked
          [view]="view1"
          [results]="cycleWaitingChartData"
          [xAxis]="showXAxis"
          [yAxis]="showYAxis"
          [showXAxisLabel]="true"
          [showYAxisLabel]="true"
          [xAxisLabel]="'Op√©ration'"
          [yAxisLabel]="'Temps (minutes)'"
          [scheme]="colorScheme"
          [animations]="false">
        </ngx-charts-bar-vertical-stacked>
        </div>
      </div>

      <!-- Rework Rate Chart -->
      <div class="chart-container">
        <div class="chart-title">Taux de Reprise par Op√©ration</div>
        <div #chartWrapper class="chart-wrapper">
        <ngx-charts-bar-vertical
          [view]="view2"
          [results]="reworkChartData"
          [xAxis]="showXAxis"
          [yAxis]="showYAxis"
          [legend]="false"
          [showXAxisLabel]="true"
          [showYAxisLabel]="true"
          [xAxisLabel]="'Op√©ration'"
          [yAxisLabel]="'Taux (%)'"
          [scheme]="colorScheme"
          [gradient]="true"
          [roundEdges]="true"
          [animations]="false">
        </ngx-charts-bar-vertical>
        </div>
      </div>
    </div>

    <!-- Operation Summary Table -->
    <div class="card mt-xl">
      <div class="card-header">D√©tails des Op√©rations (Donn√©es Python)</div>
      <div class="card-body">
        <table class="data-table">
          <thead>
            <tr>
              <th>Op√©ration</th>
              <th>WIP</th>
              <th>Temps Cycle Moy.</th>
              <th>Temps Attente Moy.</th>
              <th>Nombre de Cas</th>
              <th>Taux Reprise</th>
              <th>D√©bit</th>
              <th>Goulot</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let op of operations">
              <td><strong>{{ op.operation }}</strong></td>
              <td>{{ op.currentWIP }}</td>
              <td>{{ op.avgCycleTime.toFixed(1) }} min</td>
              <td>{{ op.avgWaitingTime.toFixed(1) }} min</td>
              <td>{{ op.caseCount }}</td>
              <td>
                <span [ngClass]="{
                  'text-error': op.reworkRate > 10,
                  'text-warning': op.reworkRate > 5 && op.reworkRate <= 10,
                  'text-success': op.reworkRate <= 5
                }">
                  {{ op.reworkRate.toFixed(1) }}%
                </span>
              </td>
              <td>{{ op.throughput.toFixed(1) }}/jour</td>
              <td>
                <span
                  class="badge"
                  [ngClass]="getSeverityBadgeClass(op.bottleneckSeverity)">
                  {{ op.bottleneckSeverity }}
                </span>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Backend Info -->
    <div class="card mt-xl" style="background: rgba(59, 130, 246, 0.1); border-color: var(--primary-blue-light);">
      <div class="flex items-center gap-md">
        <span style="font-size: 2rem;">üêç</span>
        <div>
          <strong style="color: var(--primary-blue-light);">Backend Python Actif</strong>
          <p class="text-muted" style="font-size: 0.875rem; margin-top: 0.25rem;">
            Toutes les donn√©es sont calcul√©es par le backend Python et mises √† jour en temps r√©el.
          </p>
        </div>
      </div>
    </div>
  </div>
</div>
